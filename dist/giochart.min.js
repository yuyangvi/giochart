!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e(require("lodash"),require("react"),require("g2"),require("react-dom"),require("moment"),require("antd/lib/table"),require("antd/lib/tooltip"),require("object-hash")):"function"==typeof define&&define.amd?define(["lodash","react","g2","react-dom","moment","antd/lib/table","antd/lib/tooltip","object-hash"],e):"object"==typeof exports?exports.GIO=e(require("lodash"),require("react"),require("g2"),require("react-dom"),require("moment"),require("antd/lib/table"),require("antd/lib/tooltip"),require("object-hash")):t.GIO=e(t.lodash,t.React,t.g2,t.ReactDOM,t.moment,t["antd/lib/table"],t["antd/lib/tooltip"],t["object-hash"])}(this,function(t,e,r,n,a,i,o,s){return function(t){function e(n){if(r[n])return r[n].exports;var a=r[n]={exports:{},id:n,loaded:!1};return t[n].call(a.exports,a,a.exports,e),a.loaded=!0,a.exports}var r={};return e.m=t,e.c=r,e.p="",e(0)}([function(t,e,r){t.exports=r(1)},function(t,e,r){"use strict";var n=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])};return function(e,r){function n(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),a=this&&this.__assign||Object.assign||function(t){for(var e,r=1,n=arguments.length;r<n;r++){e=arguments[r];for(var a in e)Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a])}return t};e.__esModule=!0;var i=r(2),o=r(3),s=r(4);e.Chart=s.default;var c=r(10);e.ContextListener=c.default;var l=r(16);e.DataSource=l.default;var u=r(12);e.GrTable=u.default;var m=r(8);e.retentionSourceSelector=m.retentionSourceSelector,e.retentionIntervalColumns=m.retentionIntervalColumns,e.formatPercent=m.formatPercent,e.formatNumber=m.formatNumber;var p=r(15);e.getRetention=p.getRetention;var d=function(t){t||(t="day:8,1");var e=t.split(":"),r=e[0],n=e[1],a=n.split(","),i=a[0],o=a[1];return"day"===r?parseInt(i,10)>7:"abs"!==r||parseInt(o,10)-parseInt(i,10)>6048e5};e.timeWeekRange=d;var h=function(t){function e(e){var r=t.call(this,e)||this;return r.state={field:null,order:null},r}return n(e,t),e.prototype.render=function(){var t=this.props,e=i.clone(t.params);if(t.extraColumns&&t.params.attrs&&(t.params.attrs.isAddFakeMetric=!1),this.state.field)if(/^dash_/.test(this.state.field))e.orders=[{id:this.state.field,isDim:!0,orderType:"descend"===this.state.order?"desc":"asc"}];else{var r=this.state.field.split("_"),n=r[0],a=r[1],s=i.find(e.metrics,{id:n});e.orders=[{action:a,id:n,isDim:!s,orderType:"descend"===this.state.order?"desc":"asc"}]}return o.createElement(l.default,{params:e,cacheOptions:t.cacheOptions,onLoad:t.onLoad},o.createElement(c.default,{chartType:t.chartType,colorTheme:t.colorTheme,granularities:t.params.granularities,timeRange:t.params.timeRange,adjust:t.adjust,extraColumns:t.extraColumns,groupCol:t.groupCol,range:d(t.params.timeRange),sortHandler:this.sortHandler.bind(this),isThumb:t.isThumb,attrs:e.attrs,noAggregate:t.noAggregate,legendEnable:t.legendEnable}))},e.prototype.sortHandler=function(t){this.setState(t)},e}(o.Component),f=function(t){if(!t.chartType)return null;var e=t.metrics,r=t.dimensions||[],n=[];if("singleNumber"===t.chartType&&(r="sum"===t.aggregateType?["tm"]:["tm"].concat(r)),["dimensionLine","dimensionVbar"].includes(t.chartType)&&!r.includes("tm")&&(n=n.concat({id:r[0],top:t.top}),r=["tm"].concat(r)),0===r.length&&(r=["bar"===t.chartType?"v":"tm"].concat(r)),r.includes("tm")&&(n=n.concat({id:"tm",interval:t.interval,period:"comparison"===t.chartType?"auto":void 0})),r.length<1||e.length<1)return null;var a,i;"singleNumber"===t.chartType?(a=!0,i=t.aggregateType||"sum"):["bar","abar","donut"].includes(t.chartType)&&(i="sum",a=!1);var o={aggregation:a,aggregator:i,attrs:t.attrs,dimensions:r,filter:t.filter,granularities:n,id:t.id,name:t.name,limit:["bar","abar","table"].includes(t.chartType)?t.top:void 0,metrics:e,orders:t.orders,timeRange:t.timeRange,userTag:t.userTag},s=t.chartType;"table"!==s&&o.attrs.rateChange&&(o.attrs.rateChange=void 0),"line"===s&&t.metrics.length<2&&(s="area"),s.includes("dimension")&&(s=s.replace("dimension","").toLowerCase()),"line"===s&&t.attrs.subChartType&&"seperate"!==t.attrs.subChartType&&(s="area"),"abar"===s&&(s="bar"),"funnel"===s&&(o.type="funnel");var c=t.attrs.subChartType||"dodge";"donut"===s&&(c="percent"),"seperate"===c?c="dodge":"total"===c&&(c="stack");var l=t.attrs.colorTheme;return{adjust:c,chartType:s,params:o,colorTheme:l}};e.convertChartParams=f;var g=function(t){if(t.chartType)return o.createElement(h,a({},t));var e=t.params;t.colorTheme&&(e.attrs.colorTheme=t.colorTheme);var r=f(t.params);return r?(t.groupCol&&(r.params.expanded=!0),o.createElement(h,a({extraColumns:t.extraColumns,groupCol:t.groupCol},r,{cacheOptions:t.cacheOptions,isThumb:t.isThumb,noAggregate:t.noAggregate,onLoad:t.onLoad,legendEnable:t.legendEnable}))):o.createElement("p",null,"参数不合法")};e.default=g},function(e,r){e.exports=t},function(t,r){t.exports=e},function(t,e,r){"use strict";var n=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])};return function(e,r){function n(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();e.__esModule=!0;var a=r(5),i=r(2),o=r(3),s=r(6),c=r(7),l=r(8),u=r(9);u.locale("zh-cn");var m={comparison:function(t,e){var r={},n=Math.max.apply(null,i.map(e,function(e){return a.Frame.max(t,e)}));return e.forEach(function(t){r[t]={max:n}}),{frame:t,sourceDef:r,metricCols:e}},retentionColumn:function(t,e){var r="loss",n=a.Frame.max(t,"retention");return t.addCol(r,function(t){return n-t.retention}),e=[r,"retention"],{frame:t,sourceDef:{},metricCols:e}}},p=function(t){function e(e){var r=t.call(this)||this;r.lastSelectedShape=null,r.views=[];var n=a.Util.mix(!0,a.Theme,c.CHARTTHEME);return a.Global.setTheme(n),a.Global.animate=navigator.hardwareConcurrency&&navigator.hardwareConcurrency>7,r.inspectDom=null,r}return n(e,t),e.prototype.render=function(){return o.createElement("div",{className:"giochart",style:this.props.style})},e.prototype.isValidParams=function(t,e){if("comparison"===t.chartType&&e.length&&!e[0].tm_)return!1;if("bar"===t.chartType){var r=i.find(t.columns,{isDim:!0});return"tm"!==r.id}return!0},e.prototype.componentWillReceiveProps=function(t){if(!i.isEmpty(t.source)){var e=t.source;if(this.isValidParams(t.chartParams,t.source))if(i.isEmpty(t.selected))JSON.stringify(this.props.chartParams)!==JSON.stringify(t.chartParams)?(this.chart&&(this.chart.destroy(),s.findDOMNode(this).innerHTML=""),this.drawChart(t.chartParams,e,t.isThumb,t.gridPanel,this.props.legendEnable)):JSON.stringify(e)!==JSON.stringify(this.props.source)&&(this.chart&&(this.chart.destroy(),s.findDOMNode(this).innerHTML=""),this.drawChart(t.chartParams,e,t.isThumb,t.gridPanel,this.props.legendEnable));else{var r=i.map(i.filter(t.chartParams.columns,{isDim:!0}),"id"),n=i.filter(t.selected,function(t){return i.isEmpty(i.pick(t,r))});if(i.isEmpty(n))return;var a=i.filter(e,function(t){return i.some(n,function(e){return i.isMatch(t,e)})});this.changeData(a||e)}}},e.prototype.changeData=function(t){if(this.chart){var e=this.props.chartParams,r=c.CHARTTYPEMAP[e.chartType],n=new a.Frame(t),o=i.map(i.filter(e.columns,{isDim:!1}),"id"),s=i.map(i.filter(e.columns,{isDim:!0}),"id");if(r.combineMetrics&&o.length>1){n=a.Frame.combinColumns(n,o,"val","metric",s);i.map(i.filter(e.columns,{isDim:!1}),"name")}this.chart.changeData(n)}else this.drawChart(this.props.chartParams,t,this.props.isThumb,this.props.gridPanel,this.props.legendEnable)},e.prototype.componentDidMount=function(){var t=this.props,e=t.chartParams,r=t.isThumb,n=t.source,a=t.gridPanel,i=t.legendEnable;this.isValidParams(e,n)&&n&&(this.chart&&this.chart.destroy(),this.drawChart(e,n,r,a,i))},e.prototype.componentWillUnmount=function(){this.chart&&this.chart.destroy()},e.prototype.washRecord=function(t,e){return a.Frame.filter(t,function(t){return e.every(function(e){return"number"==typeof t[e]||void 0===t[e]})})},e.prototype.getDimValues=function(t,e,r){var n=null;return n=i.map(t.data,function(t){return t.turn}),{id:r,dimValues:n}},e.prototype.combineMetrics=function(t,e,r,n){var o=i.invokeMap(i.groupBy(r,"isDim"),"map",function(t){return t.id}),s=o[0],c=o[1],l="metric",u="val";e.emptyDim&&(s=[null].concat(s));var m=null;if(n){var p=n(t,c);t=p.frame,m=p.sourceDef,c=p.metricCols}var d=i.filter(r,{isRate:!0}),h=i.max(i.map(d,function(e){return a.Frame.max(t,e.id)}));if(!e.combineMetrics&&("point"===e.geom||i.isArray(e.geom)||e.withRate||c&&c.length<2))return{frame:t,dimCols:s,metricCols:c,scales:this.buildScales(r,e.geom,m,0===h?1:h)};var f=i.map(i.filter(r,{isDim:!1}),"name"),g=i.fromPairs(i.zip(c,f));"loss"===c[0]&&"retention"===c[1]&&(g={},g.loss="未留存人数",g.retention="留存人数"),t=a.Frame.combinColumns(t,c,u,l,s),s.push(l);var v=i.find(r,{id:c[0]}),y=!!v&&v.isRate;return r=i.filter(r,{isDim:!0}).concat([{id:"metric",isDim:!0,formatterMap:g},{id:"val",isRate:y,isDim:!1}]),{frame:t,dimCols:s,metricCols:[u],scales:this.buildScales(r,e.geom,m)}},e.prototype.calculateAdjust=function(t,e){if("percent"===t)return"stack";if("line"!==e&&("interval"===e||"dodge"!==t))return t},e.prototype.calculatePosition=function(t,e,r,n){var i;if("point"===r.geom)i={pos:t[0]+"*"+t[1],x:t[0],y:t[1]};else if(e[0])if(r.withRate){var o=t.findIndex(function(t){return t.includes("rate")});i={pos:e[0]+"*"+t[o],x:e[0],y:t[o]}}else i={pos:e[0]+"*"+t[0],x:e[0],y:t[0]};else i={pos:t[0],x:void 0,y:void 0};return"percent"===n?{pos:a.Stat.summary.percent(i.pos),x:i.x,y:i.y}:i},e.prototype.calculateColor=function(t,e){return e?"l(90) 0:rgba("+e+", 0.8) 1:rgba("+e+", 0.1)":t.length>1?t[1]:""},e.prototype.calculatePlot=function(t,e,r,n,a){var o=null,s=null,l=[20,40,30,50];if(e.isThumb||a)return{margin:[0,0,0,0],colPixels:null};if(e.transpose){var u=(Math.max.apply(null,i.map(t.colArray(r[0]),"length")),document.createElement("canvas")),m=u.getContext("2d");m.font=c.CHARTTHEME.fontSize+" "+c.CHARTTHEME.fontFamily,s=t.colArray(r[0]).map(function(t){return m.measureText(t).width}),l[3]=5+c.CHARTTHEME.labelOffset+Math.min(c.CHARTTHEME.maxPlotLength,Math.max.apply(Math,s)),o=i.assign.apply(void 0,[{}].concat(t.colArray(r[0]).map(function(t,e){return r={},r[t]=s[e],r;var r})))}return!e.periodOverPeriod&&i.isArray(e.geom)&&(l[1]=50),i.isArray(e.geom)&&(l[2]=70),"area"!==n&&"bubble"!==n&&"line"!==n&&"vbar"!==n||(l[3]=10+c.CHARTTHEME.titleOffset),{margin:l,colPixels:o}},e.prototype.tooltipMap=function(t,e){var r=this;return"comparison"===t?function(t){if(3===t.items.length){var n=l.getTmFormat(e,r.props.chartParams.timeRange)(t.items[0].point._origin.tm_),a=l.getTmFormat(e,r.props.chartParams.timeRange)(t.items[0].point._origin.tm),o=l.formatPercent(parseInt(t.items[1].value,10)/parseInt(t.items[0].value,10)-1),s=t.items[0].color,c=t.items[2].color;s.includes("#")||(s=l.rgbToHex(s)),c.includes("#")||(c=l.rgbToHex(c));var u=i.assign({},t.items[0],{name:n},{title:o},{color:s}),m=i.assign({},t.items[1],{name:a},{title:o},{color:c});t.items.splice(0),t.items.push(u),t.items.push(m)}else{var s=t.items[t.items.length-1].color;t.items.splice(1),s.includes("#")||(s=l.rgbToHex(s),t.items[0].color=s),t.items[0].name.indexOf("当前")!==-1?t.items[0].title=l.getTmFormat(e,r.props.chartParams.timeRange)(t.items[0].point._origin.tm):t.items[0].title=l.getTmFormat(e,r.props.chartParams.timeRange)(t.items[0].point._origin.tm_)}}:"retention"===t?function(t){var r=i.groupBy(t.items,"color"),n=Object.keys(r);t.items.splice(0),n.forEach(function(n){var a=r[n];if(null!==e&&Object.keys(c.RetentionCOT[e]).includes(a[0].value))t.items.push(i.assign({},a[0],{value:a[1].value},{name:c.RetentionCOT[e][a[0].value]}));else{var o=a.map(function(t){return t.name+": "+t.value}).splice(1).join(", "),s=a[0].value;o.length&&(s=s+", "+o),t.items.push(i.assign({},a[0],{value:s}))}})}:void 0},e.prototype.drawChart=function(t,e,r,n,o){void 0===r&&(r=!1),void 0===n&&(n=!1),void 0===o&&(o=!1);var u=document.createElement("div");u.style.height="100%",s.findDOMNode(this).appendChild(u);var p=u.getBoundingClientRect(),d=c.CHARTTYPEMAP[t.chartType],h=new a.Frame(e),f=t.chartType,g=this.combineMetrics(h,d,t.columns,m[f]),v=g.metricCols,y=g.dimCols;h=g.frame;var T=g.scales,b=null;if(T.tm){var x=i.find(t.granularities,{id:"tm"});if(x){var C=parseInt(x.interval,10);if(b=C,"time"===T.tm.type){var _={formatter:l.getTmFormat(C,t.timeRange),axisFormatter:l.getAxisFormat(C)};C<=6048e5?(_.tickInterval=l.countTickCount(h,p.width,C),window.onresize=function(){var t=u.getBoundingClientRect();if(h&&t.width&&C){var e=i.merge({},T.tm,{tickInterval:l.countTickCount(h,t.width,C)});H.col(y[0],e),H.repaint()}}):_.tickCount=Math.ceil(i.uniq(h.colArray("tm")).length/2),i.merge(T.tm,_)}else i.merge(T.tm,{tickCount:l.countTickCountTimeCat(h,u,y[0]),formatter:l.getTmFormat(C,this.props.chartParams.timeRange),axisFormatter:l.getAxisFormat(C)}),window.onresize=function(){if(h&&u.getBoundingClientRect().width&&y[0]){var t=i.merge({},T.tm,{tickCount:l.countTickCountTimeCat(h,u,y[0])});H.col(y[0],t),H.repaint()}}}}else if("point"!==d.geom&&T[y[0]]){var w=a.Frame.group(h,y[0]).length;if("linear"===T[y[0]].type&&(T[y[0]].tickInterval=Math.ceil(60*w/(p.width-100))),c.ResizeChartType.includes(f)&&T[y[0]].values){var M=T[y[0]].values;window.onresize=function(){var t=u.getBoundingClientRect();if(h&&t.width){var e=Math.ceil(60*w/(t.width-100));if(e>1){var r=l.filterValuesByTickCount(e,M),n=l.mergeFrame(h,y[0],r.indexs);H.col(y[0],i.assign({},T[y[0]],{tickCount:r.values.length,values:r.values})),H.changeData(n)}else H.col(y[0],i.assign({},T[y[0]],{tickCount:M.length,values:M})),H.changeData(h)}}}}"percent"===t.adjust&&(T["..percent"]={formatter:l.formatPercent,type:"linear"});var D=0;if(y.length>1&&!i.isArray(d.geom)&&!r){var E=h.colArray(y[1]),k=this.drawLegend(y[1],i.uniq(E),T[y[1]],d.legendSingleMode,"top"===d.legendPosition?t.aggregator.values:null,t.attrs?t.attrs.selection:null,f,n,o);"top"===d.legendPosition?(k.className="giochart-legends top-legends",s.findDOMNode(this).insertBefore(k,u)):s.findDOMNode(this).appendChild(k),D=k.getBoundingClientRect().height}D=D>0?D+15:D,u.style.height="calc( 100% - "+D+"px)";var R=this.calculateAdjust(t.adjust,d.geom),P=this.calculatePosition(v,y,d,t.adjust),F=(y.length<=1&&["area"].includes(d.geom)||d.colorTheme)&&(t.colorTheme||d.colorTheme||"95,182,199"),O=this.calculateColor(y,F),I=p.height-D;d.transpose&&(I=Math.max(15*h.rowCount(),I));var A=this.calculatePlot(h,d,y,t.chartType,r),H=new a.Chart({container:u,forceFit:!0,height:I||300,plotCfg:{margin:A.margin}});if("bar"===f){var N=a.Frame.max(h,P.y);T[P.y].max=Math.ceil(N/4)+N}var S=T[y[0]]?T[y[0]].values:null,j=a.Frame.group(h,y[0]).length,B=Math.ceil(60*j/(p.width-100));if(B>1&&c.ResizeChartType.includes(f)&&S){var W=l.filterValuesByTickCount(B,S),q=l.mergeFrame(h,y[0],W.indexs),L=i.assign({},T[y[0]],{tickCount:W.values.length,values:W.values}),z=i.assign({},T,{turn:L});H.source(q,z)}else H.source(h,T);d.withRate||v.includes("val")||"comparison"===f?(v.forEach(function(t){H.axis(t,{title:null})}),H.axis(P.y,{title:null})):v.forEach(function(t){H.axis(t,{title:{fill:"#999",textAlign:"center"}})}),T.tm&&H.axis("tm",{formatter:T.tm.axisFormatter});var Y=null;Y=d.coord?H.coord(d.coord,{radius:1,inner:.7}):H.coord("rect"),d.transpose&&H.axis(P.x,{formatter:function(t){if(A.colPixels){if(A.colPixels[t]<=c.CHARTTHEME.maxPlotLength)return t;var e=document.createElement("canvas"),r=e.getContext("2d");r.font=c.CHARTTHEME.fontSize+" "+c.CHARTTHEME.fontFamily;for(var n=r.measureText("...").width,a=t.split("").map(function(t){return r.measureText(t).width}),i=0,o=0;i+n<=c.CHARTTHEME.maxPlotLength;)i+=a[o],o++;return t.substring(0,o-1)+"..."}return t},labelOffset:c.CHARTTHEME.labelOffset}),d.transpose&&(Y.transpose(d.transpose),d.reflect&&Y.reflect(d.reflect));var V=i.isArray(d.geom)?d.geom[0]:d.geom;if(i.isArray(d.geom)&&d.periodOverPeriod&&(H[d.geom[1]]().position(y[0]+"*"+v[1]).color("#ccc"),H.axis(v[0],!1)),d.legendSingleMode&&y.length>1){var E=h.colArray(y[1]);H.filter(y[1],[E[0]])}var G=H[V](R);i.isArray(d.geom)&&!d.periodOverPeriod&&H[d.geom[1]]().position(y[0]+"*"+v[1]).color("#ccc"),G.position(P.pos);var J=null;if((!d.shape&&O||"singleNumber"===f)&&(t.attrs&&t.attrs.selection&&t.attrs.selection.length>0?(J=a.Global.colors.trend.filter(function(e,r){return t.attrs.selection.includes(r)}),G.color(O,J)):G.color(O)),"retention"===f&&b>=6048e5&&i.find(t.columns,{id:"tm"})&&i.find(t.columns,{id:O})){var U=l.pickUnfinishRetentionByTime(h,b,O);if(U.rowCount()){var $=H.createView();$.source(U,T);var K=i.map(i.uniq(h.colArray(O)),function(){return"white"});$.line().position(P.pos).color(O,K).size(3).style({lineDash:[4,4]}),$.tooltip(!1),$.axis(!1),this.views.push($)}}var X=h.colArray(O);if("retention"===f&&(X&&i.uniq(X).length<=5||!O)){var Q=null,Z=null;"cat"===T[P.x].type?Q=H.point().position(P.pos):(Z=H.createView(),Z.source(h,T),Q=Z.point().position(P.pos),Z.tooltip(!1),Z.axis(!1),this.views.push(Z)),J?Q.color(O,J).shape("circle").opacity(1):O?Q.color(O).shape("circle").opacity(1):Q.color("#5FB6C7").shape("circle").opacity(1)}if(F){var tt=H.line().position(P.pos);tt.color("rgb("+F+")"),"singleNumber"===f&&tt.shape(d.shape)}if(d.shape&&("string"==typeof d.shape?G.shape(d.shape):G.color("#B8E986").shape(y[1],d.shape)),"point"===d.geom&&v.length>2&&G.size(v[2],40,2),d.label){var et=a.Frame.sum(h,v[0]);G.label(v[0],{offset:5,renderer:function(t,e,r){return t+"("+l.formatPercent(e.point[v[0]]/et)+")"}})}(d.isThumb||d.tooltip)&&G.tooltip(!d.isThumb&&d.tooltip),H.legend(!!i.isArray(d.geom)&&{position:"bottom"}),this.tooltipMap(f,b)?("retention"===f&&O&&G.tooltip(O+"*"+v.join("*")),H.on("tooltipchange",this.tooltipMap(f,b))):H.on("tooltipchange",function(t){var e=i.filter(t.items,function(t){return t.color.indexOf("l")===-1}),r=t.items.length;t.items.splice.apply(t.items,[0,r].concat(e))});var rt="interval"!==d.geom&&"point"!==d.geom;if(H.tooltip(!0,{custom:!0,html:'<div class="ac-tooltip" style="position:absolute;visibility: hidden;"><span class="ac-title"></span><ul class="ac-list"></ul></div>',itemTpl:'<li><svg fill={color} class="ac-svg"><circle cx="3" cy="7" r="3"/></svg>{name}: {value}</li>',offset:10,crosshairs:rt}),d.aggregator){var nt=T[v[0]];H.guide().html([-5.5,0],'<div style="text-align:center;white-space: nowrap;"><p style="color:#999;font-size:12px;">总'+nt.alias+'</p><p style="color:#333;font-size:22px;">'+nt.formatter(t.aggregator.values[0])+"</p></div>")}r&&(H.axis(!1),H.legend(!1)),H.render(),this.chart=H},e.prototype.drawLegend=function(t,e,r,n,i,o,s,c,u){var m=this,p=document.createElement("div");p.className=u?"giochart-panel-legends":"giochart-legends";var d=null;o&&o.length===e.length?d=a.Global.colors.trend:(d=a.Global.colors.default,o=Array.apply(null,Array(16)).map(function(t,e){return e}));var h=document.createElement("ul");if(h.innerHTML=e.map(function(t,e){var a=t;r.mapValues?a=r.mapValues[e]:r.formatter&&(a=r.formatter(t));var c='<li data-val="'+t+'" '+('title="'+(r.formatter?r.formatter(t):t)+'" class="'+(n&&e>0?"disabled":"")+'">'),u=null;return u="retentionColumn"===s?"loss"===t?'<svg><rect width="11" height="11" zIndex="3" stroke="#B8E986" fill="white" stroke-width="2" stroke-dasharray="3,2"></rect></svg>':'<svg fill="#B8E986"><rect width="11" height="11" zIndex="3" stroke-dasharray="3,2"></rect></svg>':'<svg fill="'+d[o[e]%d.length]+'"><rect width="11" height="11" zIndex="3"></rect></svg>',c+u+a+(i?"：<span>"+l.formatPercent(i[e])+"</span>":"")+"</li>"}).join(""),p.appendChild(h),this.legends=e.map(function(t,e){return{color:a.Global.colors.default[e],dotDom:p.querySelector("li:nth-child("+(1+e)+")"),isChecked:!(n&&e>0),name:t}}),h.addEventListener("click",function(e){for(var r=e.target,a=e.currentTarget;a.contains(r);){var i=r.getAttribute("data-val");if(i)return e.stopPropagation(),void m.filter(t,i,n);r=r.parentNode}}),i)return p;var f=document.createElement("div");f.className="giochart-legend-scroller",f.innerHTML='<span><i class="anticon anticon-caret-up" data-action="up"></i></span><span><i class="anticon anticon-caret-down" data-action="down"></i></span>',p.appendChild(f);var g=0;return f.addEventListener("click",function(t){t.stopPropagation();var e=t.target,r=h.getBoundingClientRect().height,n=e.getAttribute("data-action");"up"===n&&g>39?(g-=40,h.style.transform="translate(0, "+-g+"px)"):"down"===n&&r>g+40&&(g+=40,h.style.transform="translate(0, "+-g+"px)")}),"donut"===s&&(h.style.textAlign="center",h.style.width="100%"),f.style.display=u&&h.children.length>10?"block":"none",p},e.prototype.filter=function(t,e,r){var n=i.find(this.legends,{name:e}),a=[];n.isChecked&&r||(n.isChecked=!n.isChecked,this.legends.forEach(function(t){(r?t.name===n.name:t.isChecked)?(t.isChecked=!0,t.dotDom.className="",a.push(t.name)):(t.dotDom.className="disabled",t.isChecked=!1)}),this.views.length>0&&this.views.forEach(function(e){e.filter(t,a)}),this.chart.filter(t,a),this.chart.repaint())},e.prototype.unselectHandler=function(t,e){},e.prototype.selectHandler=function(t,e){var r=t.shape;if(r){t.geom._attrs.selectedCfg.selectedMode;if(r.get("selected")){var n=r.get("origin");i.pick(n._origin,e)}else var n=r.get("origin")}},e.prototype.buildScales=function(t,e,r,n){void 0===n&&(n=1);var a={};return"string"!=typeof e&&(e=e[0]),t.forEach(function(t,r){"tm"===t.id?a.tm={type:"interval"===e?"timeCat":"time",formatter:function(t){return u.unix(t/1e3).format(t%864e5===576e5?"MM-DD ddd":"HH:mm")}}:t.isDim?(a[t.id]={alias:t.name,type:"cat"},t.formatterMap&&(a[t.id].formatter=function(e){return t.formatterMap[e]}),t.values&&(0===r?a[t.id].values=t.values:a[t.id].mapValues=t.values)):a[t.id]={alias:t.name,type:"linear",min:0,max:t.isRate?n:void 0,tickCount:t.isRate?6:void 0,formatter:t.isRate?l.formatPercent:l.formatNumber}}),r?i.defaultsDeep(r,a):a},e}(o.Component);e.default=p},function(t,e){t.exports=r},function(t,e){t.exports=n},function(t,e){"use strict";e.__esModule=!0,e.CHARTTYPEMAP={area:{geom:"area"},bar:{geom:"interval",reflect:"y",transpose:!0,label:!0},bubble:{geom:"point",shape:"circle"},comparison:{geom:["area","line"],periodOverPeriod:!0,colorTheme:"252, 95, 58"},dualaxis:{geom:["interval","line"]},funnel:{geom:"line",withRate:!0},funnelChart:{geom:"line",withRate:!0,legendPosition:"top"},line:{geom:"line"},retentionColumn:{geom:"interval",shape:["hollowRect","stroke"],withRate:!0,combineMetrics:!0},retention:{geom:"line",withRate:!0},singleNumber:{geom:"area",shape:"smooth",isThumb:!0},vbar:{geom:"interval"},donut:{geom:"interval",emptyDim:!0,coord:"theta",aggregator:!0}};var r=["#5FB6C7","#FFD159","#C9C77C","#FA7413","#D6DCE3","#6F5D45","#FDF0A1","#bf1f41","#A1EBDE","#CBBD8C","#B96285","#8a73c9","#005a03","#320096","#673000","#2d396b"],n=["#C9DE00","#FF4500","#00BFD8","#FFEC00","#734A3F","#375167","#587E8D","#9E9E9E","#FFBF00","#3C4FBC","#6AB626","#AB02B6","#00ABFB","#6F31BE","#FE0061","#00B341","#009988","#FF2825","#FFA300","#0096FB"];e.CHARTTHEME={animate:!1,labelOffset:15,titleOffset:60,axis:{bottom:{labels:{autoRotate:!1},title:null},left:{labels:{autoRotate:!1},line:null,tickLine:{lineWidth:0,stroke:"#fcc"}},right:{labels:{autoRotate:!1},title:null}},colors:{default:r,intervalStack:r,trend:n},defaultColor:"#5FB6C7",legend:!1,shape:{area:{fill:"#5FB6C7",size:0},hollowPoint:{fill:"#5FB6C7"},hollowInterval:{lineDash:[3,2],lineWidth:1},interval:{fill:"#abce5b",fillOpacity:1,stroke:"#5FB6C7"},line:{stroke:"#5FB6C7",lineWidth:2},point:{fill:"#5FB6C7",fillOpacity:.5}},tooltip:{tooltipMarker:{stroke:"#5FB6C7"}},maxPlotLength:145,fontSize:"12px",fontFamily:"Arial"},e.ResizeChartType=["retention","retentionColumn"],e.RetentionCOT={2592e6:{1:"次月留存率",2:"2月留存率",3:"3月留存率"},6048e5:{1:"次周留存率",2:"2周留存率",3:"3周留存率",4:"4周留存率"},864e5:{1:"次日留存率",7:"7日留存率",14:"14日留存率",30:"30日留存率"}}},function(t,e,r){"use strict";e.__esModule=!0;var n=r(5),a=r(9),i=r(2);e.formatNumber=function(t){if("number"!=typeof t)return t;var e=["","万","亿","万亿"],r=Math.max(0,Math.min(3,Math.floor(Math.log10(Math.abs(t))/4)));return r<1?Number.isInteger(t)?""+t:parseFloat(t.toPrecision(3)).toString():parseFloat((t*Math.pow(.1,4*r)).toPrecision(3))+e[r]},e.filterValuesByTickCount=function(t,e){var r=e.map(function(e,r){if(r%t===0)return r}).filter(function(t){return void 0!==t}),n=e.filter(function(t,e){return r.includes(e)});return n.includes(e[e.length-1])||(n.push(e[e.length-1]),r.push(e.length-1)),n.includes(e[1])||(n.splice(1,0,e[1]),r.splice(1,0,1)),{indexs:r,values:n}},e.mergeFrame=function(t,e,r){var a=n.Frame.filter(t,function(t,e){return r.includes(t.turn)}),i=a.colArray(e),o=i.map(function(t){return r.indexOf(t)});return a.colReplace(e,o)},e.formatPercent=function(t){return"number"!=typeof t?t:t?0<t&&t<.001?"< 0.1%":0>t&&t>.001?"> -0.1%":parseFloat((100*t).toPrecision(3))+"%":"0%"},e.calculateTimeRange=function(t){t||(t="day:8,1");var e=t.split(":"),r=e[0],n=e[1],a=n.split(","),i=a[0],o=a[1];return"day"===r?864e5*(parseInt(i,10)-parseInt(o,10)):"abs"===r?parseInt(o,10)-parseInt(i,10):"week"===r?6048e5*(parseInt(i,10)-parseInt(o,10)):"month"===r?2592e6*(parseInt(i,10)-parseInt(o,10)):void 0},e.countTickCount=function(t,e,r){var a=(n.Frame.range(t,"tm"),n.Frame.group(t,["tm"]).length,n.Frame.range(t,"tm")),i=a[0],o=a[1],s=(o-i)/e*80;if(s){if(r>864e5)return Math.ceil(s/r)*r;if(o-i>864e5)return 864e5*Math.ceil(s/864e5);var c=Math.ceil(s/36e5),l=[24,12,8,6,4,3,2,1].reduce(function(t,e){return c>e?t:e});return 36e5*l}},e.countTickCountTimeCat=function(t,e,r){var a=e.getBoundingClientRect(),i=n.Frame.group(t,r).length,o=Math.ceil(60*i/(a.width-100));if(1===o)return i;for(;o<=Math.ceil(i/2);){if((i-1)%o===0)return(i-1)/o+1;o++}return 2},e.getTmFormat=function(t,r){var n=e.flattenDateRange(r);return t>6048e5?function(t){return a.unix(Math.max(n.startTime,t)/1e3).format("MM/DD ddd")+" ~ "+a.min(a.unix(n.endTime/1e3),a.unix(t/1e3).endOf("month")).format("MM/DD ddd")}:6048e5===t?function(t){return a.unix(Math.max(n.startTime,t)/1e3).format("MM/DD ddd")+" ~ "+a.min(a.unix(n.endTime/1e3),a.unix(t/1e3).endOf("week")).format("MM/DD ddd")}:864e5===t?function(t){return a.unix(t/1e3).format("MM/DD ddd")}:36e5===t?function(t){return a.unix(t/1e3).format("MM/DD ddd HH:mm")}:function(t){return a.unix(t/1e3).format("MM/DD ddd")}},e.getTmTableFormat=function(t,r,n){void 0===n&&(n=!1);var i=e.flattenDateRange(r);return t>6048e5?n?function(t){var e=a.unix(Math.max(i.startTime,t)/1e3),r=a.min(a.unix(i.endTime/1e3),a.unix(t/1e3).endOf("month"));return e.format("MM/DD")+"~"+r.format("MM/DD")+","+Math.round((r.unix()-e.unix())/86400)+"天"}:function(t){var e=a.unix(Math.max(i.startTime,t)/1e3),r=a.min(a.unix(i.endTime/1e3),a.unix(t/1e3).endOf("month"));return e.format("MM/DD")+" - "+r.format("MM/DD")}:6048e5===t?n?function(t){var e=a.unix(Math.max(i.startTime,t)/1e3),r=a.min(a.unix(i.endTime/1e3),a.unix(t/1e3).endOf("week"));return e.format("MM/DD")+"~"+r.format("MM/DD")+","+e.format("ddd")+"~"+r.format("ddd")+","+Math.round((r.unix()-e.unix())/86400)+"天"}:function(t){var e=a.unix(Math.max(i.startTime,t)/1e3),r=a.min(a.unix(i.endTime/1e3),a.unix(t/1e3).endOf("week"));return e.format("MM/DD")+" - "+r.format("MM/DD")}:864e5===t?function(t){return a.unix(t/1e3).format("MM-DD ddd")}:36e5===t?function(t){return a.unix(t/1e3).format("MM-DD ddd HH:mm")}:function(t){return a.unix(t/1e3).format("MM-DD ddd")}},e.getAxisFormat=function(t){var e=["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"];return t>6048e5?function(t){return e[parseInt(t.slice(0,2),10)-1]}:6048e5===t?function(t){return t.replace(/(\d+\/\d+)\s[^\s]+\s~\s(\d+\/\d+)\s[^\s]+/,function(t,e,r){return e+"~"+r})}:36e5===t?function(t){var e=t.split(" ");return"00:00"===e[e.length-1]?e[0]:e[e.length-1]}:void 0},e.pickUnfinishRetentionByTime=function(t,e,r){var o=e>6048e5?"months":"weeks",s=t.toJSON(),c=[];return s.forEach(function(t,e,n){var s="months"===o?"month":"week",l=a.unix(t.tm/1e3).add(parseInt(t.turn,10),o).endOf(s),u=a().subtract(1,"days");a(l.format("YYYY-MM-DD")).isAfter(u.format("YYYY-MM-DD"))?(e-1>=0&&t[r]===n[e-1][r]&&c.splice(c.length-1,1,n[e-1]),c.push(n[e])):c.push(i.assign({},n[e],{retention:null,retention_rate:null}))}),new n.Frame(c)},e.retentionIntervalColumns=function(t,r){var n=Math.floor(e.calculateTimeRange(r)/t),a=[];return 6048e5===t?a=[1,2,3,4]:2592e6===t?a=[1,2,3]:864e5===t&&(a=[1,7,14,30]),i.map(i.filter(a,function(t){return t<=n}),function(t){return t.toString()})},e.retentionSourceSelector=function(t,r,n,a,o){var s=(n?i.reject:i.filter)(t,{tm:0});if(n){var c=e.retentionIntervalColumns(a,o),l=i.filter(i.flatten(i.map(c,function(t){return i.map(s,function(e){var n=i.pick(e,r);return void 0===e["retention_"+t]?null:(i.assign(n,{turn:t,retention:e["retention_"+t],retention_rate:e["retention_rate_"+t]}),n)})})));return l}var u=i.map(s,function(t){var e=i.pick(t,r),n=i.transform(t,function(t,e,r){var n=r.match(/^(retention(?:_rate)?)_(\d+)$/);if(n){var a=parseInt(n[2],10);t[a]||(t[a]={}),t[a][n[1]]=e}},[]);return i.map(n,function(t,r){return i.assign(t,e,{turn:r})})});return i.flatten(u)},e.getRetentionParams=function(t,r,n,a){var s=i.filter(r,function(t){return"tm"!==t.id&&t.isDim}).reverse(),c=!!s.length;if(a&&!c){var l=n.granularities,u=i.find(l,{id:"tm"}).interval,m=n.timeRange,p=e.retentionIntervalColumns(parseInt(u,10),m),d=i.filter(r,function(t){var e=t.id.match(/^retention(?:_rate)_(\d+)$/);return e&&p.includes(e[1])});s=[{id:"turn",name:"留存周期",isDim:!0,isRate:!1,values:i.map(d,"name")}]}var h=a?{id:"tm",name:"起始时间",isDim:!0,isRate:!1}:{id:"turn",name:"留存",isDim:!0,isRate:!1,values:o(r)},f=[{id:"retention_rate",name:"留存率",isDim:!1,isRate:!0},{id:"retention",name:"留存人数",isDim:!1,isRate:!1}];return"count"===t&&(f=f.reverse()),{adjust:"stack",chartType:"count"===t?"retentionColumn":"retention",columns:[h].concat(s,f)}};var o=function(t){return i.map(i.filter(t,function(t){return/^retention_\d+$/.test(t.id)}),"name")},s=function(t){var e=t.toString(16);return 1===e.length?"0"+e:e};e.rgbToHex=function(t){var e=/\d+/g,r=t.match(e);return"#"+s(parseInt(r[0],10))+s(parseInt(r[1],10))+s(parseInt(r[2],10))},e.hexToRgb=function(t){var e=/^#?([a-f\d])([a-f\d])([a-f\d])$/i;t=t.replace(e,function(t,e,r,n){return e+e+r+r+n+n});var r=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return r?{r:parseInt(r[1],16),g:parseInt(r[2],16),b:parseInt(r[3],16)}:null},e.flattenDateRange=function(t){void 0===t&&(t="day:7,1");if("object"==typeof t)return t.type="absolute",t;t=t.trim();var e=t.match(/(day|week|month|year)\:(1\,0|prev)/);if(e){var r="week"===e[1]?"isoWeek":e[1],n="prev"===e[2]?r:"day",i="prev"===e[2]?e[1]:"day";return{type:"relative",startTime:a().subtract(1,i).startOf(r).valueOf(),endTime:a().subtract(1,i).endOf(n).valueOf()}}var o=t.match(/(\w+)\:(\d+),(\d+)/);return"abs"===o[1]?{type:"absolute",startTime:parseInt(o[2],10),endTime:parseInt(o[3],10)}:o?{type:"relative",startTime:a().subtract(parseInt(o[2],10)-1,"days").startOf("day").valueOf(),endTime:a().subtract(parseInt(o[3],10),"days").endOf("day").valueOf()}:void 0}},function(t,e){t.exports=a},function(t,e,r){"use strict";var n=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])};return function(e,r){function n(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();e.__esModule=!0;var a=r(3),i=r(11),o=r(4),s=r(12),c=r(15),l=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return n(e,t),e.prototype.render=function(){var t=this.generateChartParams(),e=["comparison","singleNumber"].includes(t.chartType);if("table"===t.chartType)return a.createElement(s.default,{chartParams:t,extraColumns:this.props.extraColumns,
source:this.context.source,select:this.props.select,selected:this.context.selected,sortHandler:this.props.sortHandler,startTime:this.context.startTime,trackWords:this.context.trackWords});if(!this.context.source||!this.context.source.length){var r={"-webkit-box-orient":"vertical","-webkit-box-pack":"center",display:"-webkit-box",height:"100%"},n={color:"#999999",fontSize:16,fontWeight:200,textAlign:"center"};return a.createElement("div",{style:r},a.createElement("div",{style:n},"暂无数据"))}if(e){var l=!!(this.context.columns&&this.context.columns.length>1&&this.context.columns[1].isRate);return this.props.noAggregate?a.createElement(o.default,{chartParams:t,colorTheme:this.props.colorTheme,source:this.context.source,select:this.props.select,selected:this.context.selected,startTime:this.context.startTime,trackWords:this.context.trackWords,legendEnable:this.props.legendEnable,isThumb:this.props.isThumb}):a.createElement("div",{className:"gr-chart-wrapper "+t.chartType},a.createElement(i.default,{data:this.context.aggregator.values,period:this.props.range,isRate:l,chartType:t.chartType}),a.createElement(o.default,{chartParams:t,colorTheme:this.props.colorTheme,source:this.context.source,select:this.props.select,selected:this.context.selected,startTime:this.context.startTime,trackWords:this.context.trackWords,isThumb:this.props.isThumb,legendEnable:this.props.legendEnable}))}if("singleNumber"===t.chartType)return a.createElement("div",{className:"gr-chart-wrapper"},a.createElement(i.default,{data:this.context.aggregator.values,period:this.props.range}),a.createElement(o.default,{chartParams:t,colorTheme:this.props.colorTheme,source:this.context.source,select:this.props.select,style:{height:"calc(100% - 40px)"},selected:this.context.selected,startTime:this.context.startTime,trackWords:this.context.trackWords,isThumb:this.props.isThumb,legendEnable:this.props.legendEnable}));if(["retention","retentionTrend"].includes(t.chartType)){var u={granularities:t.granularities,timeRange:t.timeRange,attrs:t.attrs},m=c.getRetention(t.columns,this.context.source,u,!1,!0);return a.createElement(o.default,{chartParams:m.params,colorTheme:this.props.colorTheme,source:m.source,startTime:this.context.startTime,trackWords:this.context.trackWords,isThumb:this.props.isThumb,legendEnable:this.props.legendEnable})}return a.createElement(o.default,{chartParams:t,source:this.context.source,select:this.props.select,selected:this.context.selected,startTime:this.context.startTime,trackWords:this.context.trackWords,isThumb:this.props.isThumb,legendEnable:this.props.legendEnable})},e.prototype.generateChartParams=function(){return this.props.hasOwnProperty("chartParams")?this.props.chartParams:{adjust:this.props.adjust,aggregator:this.context.aggregator,chartType:this.props.chartType,colorTheme:this.props.colorTheme,columns:this.context.columns,granularities:this.props.granularities,groupCol:this.props.groupCol,timeRange:this.props.timeRange,attrs:this.props.attrs}},e.contextTypes={aggregator:a.PropTypes.any,columns:a.PropTypes.array,extraColumns:a.PropTypes.any,selectHandler:a.PropTypes.func,selected:a.PropTypes.any,source:a.PropTypes.any,startTime:a.PropTypes.number,trackWords:a.PropTypes.any},e}(a.Component);e.default=l},function(t,e,r){"use strict";e.__esModule=!0;var n=r(3),a=r(8),i=function(t){var e=t.data,r=(t.period,"comparison"===t.chartType);return t.data?n.createElement("div",{className:"gr-chart-aggregate-info"},n.createElement("div",{className:"gr-chart-aggregate-inner"},n.createElement("div",{className:"gr-chart-aggregate-num"},t.isRate?a.formatPercent(t.data[0]):r?s(t.data[0]):a.formatNumber(t.data[0]),n.createElement("span",{className:"suffix"})),e[1]?n.createElement(o,{percent:t.data[0]/t.data[1]-1,period:t.period}):null)):null},o=function(t){return n.createElement("div",{className:"gr-chart-aggregate-percent"},n.createElement("div",{className:"gr-chart-trend-"+(t.percent>0?"up":"down")},n.createElement("svg",{className:"svg-icon"},n.createElement("use",{href:"#icon-"+(t.percent>0?"up":"down")+"-trend"})),n.createElement("span",null,a.formatPercent(Math.abs(t.percent)).slice(0,-1)),n.createElement("span",{style:{fontSize:12}},"%")),n.createElement("span",{className:"gr-chart-trend-desc"},t.period?"相比上周期":"相比7天前"))},s=function(t){if("number"!=typeof t||!isFinite(t))return t.toString();var e="";return e=t>=100?t.toFixed(0):t<10?t.toFixed(2):t.toFixed(1),e.replace(/^\d+/g,function(t){return t.replace(/(?=(?!^)(\d{3})+$)/g,",")})};e.default=i},function(t,e,r){"use strict";var n=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])};return function(e,r){function n(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();e.__esModule=!0;var a=r(13),i=r(14),o=a,s=i,c=r(2),l=r(9),u=r(3),m=r(8),p=r(5),d=function(t){return function(e,r){return e[t]>=r[t]?1:-1}};l.locale("zh-cn");var h=function(t,e){return function(r){return null===e?"":r>e?"rgba(255,211,99, "+.5*(r-e)/(t[1]-e)+")":r<e?"rgba(95,182,199, "+.5*(r-e)/(t[0]-e)+")":void 0}},f=function(t,e){if(t){if(e)return(100*t).toPrecision(3)+"%";if(!Number.isInteger(t))return t>=1e3?Math.round(t).toString():t.toPrecision(3)}return"string"==typeof t?t:null===t?"":void 0===t?void 0:t.toString()},g=function(t,e){return function(r){return{children:f(r,e.isRate),props:{style:{backgroundColor:t(r)}}}}},v=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.lastSorter={},e}return n(e,t),e.formatDate=function(t){return l.unix(t/1e3).format("YYYY-MM-DD")},e.getRowKey=function(t,e){return""+e},e.prototype.checkDate=function(t){var e=this;if("tm"===t.id){var r=c.find(this.props.chartParams.granularities,{id:"tm"});return function(t){return u.createElement(s,{title:m.getTmTableFormat(parseInt(r.interval,10),e.props.chartParams.timeRange,!0)(t)},m.getTmTableFormat(parseInt(r.interval,10),e.props.chartParams.timeRange)(t))}}},e.groupFlatter=function(t,e,r,n){return t.reduce(function(t,a){var i=r.indexOf(a[e]);return c.forIn(a,function(r,o){o!==e&&(n.includes(o)?t[o]=a[o]:t[e+"_"+i+"_"+o]=a[o])}),t},{})},e.prototype.render=function(){var t=this,r=this.props.chartParams,n=this.props.source,a=[];try{if(!n||!r)return null;if(r.groupCol){var i=c.difference(c.map(c.filter(r.columns,"isDim"),"id"),[r.groupCol]),s=c.filter(r.columns,{isDim:!1}),l=c.flatMap(c.unionBy(n,r.groupCol),r.groupCol),m=function(t){return c.values(c.pick(t,i)).join("")},f=c.values(c.groupBy(n,m));n=c.map(f,function(t){return e.groupFlatter(t,r.groupCol,l,i)});var v=new p.Frame(n);a=c.map(i,function(t){return{dataIndex:t,key:t,sorter:d(t),title:c.find(r.columns,{id:t}).name}});var y=l.map(function(t,e){return{title:t,children:c.map(s,function(t){var n=r.groupCol+"_"+e+"_"+t.id;return{className:"metric",dataIndex:n,key:n,render:g(h(p.Frame.range(v,n),p.Frame.median(v,n)),t),sorter:d(n),title:t.name}})}});a=a.concat(y)}else{var T=new p.Frame(n);a=r.columns.map(function(e,r){return{className:e.isDim?void 0:"metric",dataIndex:e.id,key:e.id+"_"+r,render:e.isDim?t.checkDate(e):g(h(p.Frame.range(T,e.id),p.Frame.median(T,e.id)),e),sorter:d(e.id),title:e.name}})}if(this.props.hasOwnProperty("extraColumns")&&this.props.extraColumns){var b=this.props.extraColumns;c.find(a,{dataIndex:b.dataIndex})||(b.render||(b.render=function(t){return t}),a=a.concat(b))}return u.createElement(o,{bordered:!0,columns:a,dataSource:n,pagination:n.length>10&&{pageSize:10},rowKey:e.getRowKey,onChange:this.onChange.bind(this),ref:this.onLoad.bind(this)})}catch(t){return this.track("report_render_fail"),null}},e.prototype.onLoad=function(t){t&&this.track("report_render_success")},e.prototype.track=function(t){try{var e=window._vds;e.track(t,{project_id:window.project.id,chart_name:this.props.trackWords.name,board_name:this.props.trackWords.board_name,report_load_time:Date.now()-this.props.startTime,channel_name:this.props.trackWords.channel_name})}catch(t){return}},e.prototype.onChange=function(t,e,r){c.isEqual(this.lastSorter,r)||(this.props.sortHandler(r),this.lastSorter=r)},e}(u.Component);e.default=v},function(t,e){t.exports=i},function(t,e){t.exports=o},function(t,e,r){"use strict";e.__esModule=!0;var n=r(2),a=function(t){t||(t="day:8,1");var e=t.split(":"),r=e[0],n=e[1],a=n.split(","),i=a[0],o=a[1];return"day"===r?864e5*(parseInt(i,10)-parseInt(o,10)):"abs"===r?parseInt(o,10)-parseInt(i,10):"week"===r?6048e5*(parseInt(i,10)-parseInt(o,10)):"month"===r?2592e6*(parseInt(i,10)-parseInt(o,10)):void 0};e.retentionIntervalColumns=function(t,e){var r=Math.floor(a(e)/t),i=[];return 6048e5===t?i=[1,2,3,4]:2592e6===t?i=[1,2,3]:864e5===t&&(i=[1,7,14,30]),n.map(n.filter(i,function(t){return t<=r}),function(t){return t.toString()})},e.getRetention=function(t,r,a,c,l){var u=n.find(a.granularities,{id:"tm"}).interval,m=a.timeRange,p=c||!l?e.retentionIntervalColumns(parseInt(u,10),m):n.reduce(t,function(t,e){var r=e.id.match(/^retention(?:_rate)_(\d+)$/);return r&&t.push(r[1]),t},[]),d=n.filter(t,function(t){return"tm"!==t.id&&t.isDim}).reverse(),h=!!d.length,f=s(t,c,l,h,p),g=n.map(f,"id"),v=o(r,c,g,p),y=[{id:"retention_rate",name:"留存率",isDim:!1,isRate:!0},{id:"retention",name:"留存人数",isDim:!1,isRate:!1}];return l||(y=y.reverse()),{params:{adjust:"stack",chartType:l?"retention":"retentionColumn",columns:f.concat(y),timeRange:a.timeRange,granularities:a.granularities,attrs:a.attrs},source:i(v,r,a,t,c)}};var i=function(t,e,r,a,i){var o=n.find(a,{id:"comparison_value"});if(!o)return t;var s=r.attrs.selection,c=n.filter(n.map(n.filter(e,{tm:0}),"comparison_value"),function(t,e){return s.includes(e)});return n.filter(t,function(t){return!i&&c.includes(t.comparison_value)})},o=function(t,e,r,a){var i=(e?n.reject:n.filter)(t,{tm:0});return n.reduce(i,function(t,e,i){var o=n.pick(e,r);return n.forEach(a,function(r){void 0!==e["retention_"+r]&&t.push(n.assign({turn:parseInt(r,10),retention:e["retention_"+r],retention_rate:e["retention_rate_"+r]},o))}),t},[])},s=function(t,e,r,a,i){var o=a?n.filter(t,function(t){return"tm"!==t.id&&t.isDim}).reverse():[];if(e&&!a){var s=n.filter(t,function(t){var e=t.id.match(/^retention(?:_rate)_(\d+)$/);return e&&n.includes(i,e[1])});o=[{id:"turn",name:"留存周期",isDim:!0,isRate:!1,values:n.map(s,"name")}]}var l=e?{id:"tm",name:"起始时间",isDim:!0,isRate:!1}:{id:"turn",name:"留存",isDim:!0,isRate:!1,values:c(t)},u=[{id:"retention_rate",name:"留存率",isDim:!1,isRate:!0},{id:"retention",name:"留存人数",isDim:!1,isRate:!1}];return r||(u=u.reverse()),[l].concat(o)},c=function(t){return n.map(n.filter(t,function(t){return/^retention_\d+$/.test(t.id)}),"name")}},function(t,e,r){"use strict";var n=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])};return function(e,r){function n(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();e.__esModule=!0;var a=r(2),i=r(3),o=r(17);e.HttpStatus={Ok:200,Created:201,NoContent:204,MovedPermanently:301,SeeOther:303,NotModified:304,BadRequest:400,Unauthorized:401,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,RequestTimeout:408,UnsupportedEntity:422,Locked:423,TooManyRequests:429,InternalServerError:500,NotImplemented:501};var s=function(t){var e="";try{e=JSON.parse(t),e=e.message,"string"==typeof e&&(e=JSON.parse(e),e=e.reason)}catch(t){e="网络错误"}return e},c=function(t){function r(e){var r=t.call(this,e)||this;return r.tryTimes=0,r.startTime=0,r.trackWords={board_name:"",channel_name:"",name:""},r.xhr="",r.state={aggregator:null,columns:null,error:!1,loading:!0,selected:null,source:null},r}return n(r,t),r.prototype.render=function(){if(this.state.error){var t={101:"数据加载失败",102:"业务计算超时"};return i.createElement("div",{className:"chart-error"},i.createElement("div",null,"抱歉，",t[this.state.error],i.createElement("br",null),"请稍后重试"))}return this.state.loading?i.createElement("div",{className:"gr-loading-mask"},i.createElement("div",{className:"loading-gif"})):i.Children.only(this.props.children)},r.prototype.getChildContext=function(){return{aggregator:this.state.aggregator,columns:this.state.columns,selected:this.state.selected,source:this.state.source,startTime:this.startTime,trackWords:this.trackWords}},r.prototype.componentWillReceiveProps=function(t){if(!a.isEqual(this.props.params,t.params)){if(t.hasOwnProperty("cacheOptions")){var e=o.getChartData(t.params,t.hashKeys);if(e)return void this.setState(e)}this.startTime=Date.now(),this.setState({error:!1,loading:!0}),this.defaultRequest(t.params,this.afterFetch.bind(this))}},r.prototype.defaultRequest=function(t,r){var n=this;this.xhr&&this.xhr.abort();var a=new XMLHttpRequest;this.props.hasOwnProperty("sourceUrl")?(a.open("get",this.props.sourceUrl,!0),a.send(null)):(a.open("post",window.gateway+"/_private/v4/projects/"+project.id+"/chartdata",!0),a.timeout=6e4,a.withCredentials=!0,a.setRequestHeader("credentials","include"),a.setRequestHeader("accept","application/json"),a.setRequestHeader("Content-Type","application/json"),a.send(JSON.stringify(t))),a.onreadystatechange=function(){if(4===a.readyState)if(a.status===e.HttpStatus.Ok){var i=JSON.parse(a.responseText);r(i,t)}else if(a.status===e.HttpStatus.RequestTimeout&&n.tryTimes<2)n.tryTimes++,setTimeout(n.defaultRequest.bind(n,t,r),200);else{n.setState({error:a.status===e.HttpStatus.RequestTimeout?102:101,loading:!1});var o=window._vds;o&&o.track("report_load_fail",{project_id:window.accountId,project_name:window.project.name,chart_name:t.name,board_name:n.trackWords.board_name,report_load_time:Date.now()-n.startTime,channel_name:n.trackWords.channel_name,error_msg:s(a.responseText)})}},a.ontimeout=function(e){a.abort&&a.abort(),n.setState({error:102,loading:!1});var r=window._vds;r&&r.track&&r.track("report_load_fail",{project_id:window.accountId,project_name:window.project.name,chart_name:t.name,board_name:n.trackWords.board_name,report_load_time:Date.now()-n.startTime,channel_name:n.trackWords.channel_name,error_msg:s(a.responseText)})}},r.prototype.componentWillMount=function(){var t=this.props.params;try{var e=location.pathname.match(/\/projects\/\w{8}\/([^\/]+)(?:\/([^\/]+))?/);e&&e.length>2&&(this.trackWords={channel_name:e[1],board_name:e[2],name:t.name})}catch(t){}if(this.props.hasOwnProperty("cacheOptions")){var r=o.getChartData(t,this.props.hashKeys);if(r)return this.setState(r),void(this.props.onLoad&&this.props.onLoad(r))}this.startTime=Date.now(),this.defaultRequest(t,this.afterFetch.bind(this))},r.prototype.componentWillUnmount=function(){this.xhr&&this.xhr.abort()},r.prototype.afterFetch=function(t,e){if(this.xhr=null,a.isEqual(e,this.props.params)){var r=t.meta.columns;r.forEach(function(t){!t.isDim&&t.metricId&&t.metricId.action&&(t.id+="_"+t.metricId.action||"")});var n=a.map(r,"id"),i=t.meta.offset,s=t.data;if(void 0!==t.meta.offset){var c=6048e5;s=a.zipWith(s.slice(0,i),s.slice(i),function(t,e){return(t||[e[0]+c,null]).concat(e)}),n=n.concat(a.map(n,function(t){return t+"_"})),r[1].name="当前周期",r=r.concat(a.map(r,function(t){return a.assign({},t,{id:t.id+"_",name:t.isDim?void 0:"上一周期"})}))}var l=a.map(s,function(t){return a.zipObject(n,t)});if(e.attrs&&e.attrs.isAddFakeMetric){var u=r[r.length-1];u.name+="转化率",u.isRate=!0;var m=u.id;l.forEach(function(t){t["9yGbpp8x"]?t[m]/=t["9yGbpp8x"]:t[m]=void 0})}if(!l||0===l.length)try{var p=window._vds;p.track("report_no_data",{project_id:window.accountId,project_name:window.project.name,chart_name:e.name,board_name:this.trackWords.board_name,report_load_time:Date.now()-this.startTime,channel_name:this.trackWords.channel_name,params:JSON.stringify(e)})}catch(t){}var d={aggregator:t.meta.aggregator||null,columns:r,error:!1,loading:!1,source:l};this.props.hasOwnProperty("cacheOptions")&&o.setChartData(e,d,this.props.hashKeys,this.props.cacheOptions),this.setState(d),this.props.onLoad&&this.props.onLoad(d)}},r.childContextTypes={aggregator:i.PropTypes.any,columns:i.PropTypes.array,selectHandler:i.PropTypes.func,selected:i.PropTypes.any,source:i.PropTypes.any,startTime:i.PropTypes.number,trackWords:i.PropTypes.any},r}(i.Component);e.default=c},function(t,e,r){"use strict";function n(t,e){var r="";return r=c(e?e:t)}function a(t){t?delete u[t]:u={}}function i(t,e,r,a){var i=n(t,r),o=-1,s={};a&&!isNaN(a.ttl)&&parseInt(a.ttl,10)!==-1&&60*a.ttl*1e3!==0&&(o=60*a.ttl*1e3+Date.now()),s[i]={ttl:o,chartData:e},l.assign(u,s)}function o(t,e){var r,i="",o=null;return i=n(t,e),u[i]&&(r=u[i].ttl!==-1&&u[i].ttl<Date.now(),r?a(i):o=u[i].chartData),o}function s(){return u}e.__esModule=!0;var c=r(18),l=r(2),u={};e.cleanCache=a,e.setChartData=i,e.getChartData=o,e.getChartDataCache=s},function(t,e){t.exports=s}])});